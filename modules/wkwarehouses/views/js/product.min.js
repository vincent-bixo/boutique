/**
* NOTICE OF LICENSE
*
* This file is part of the 'Wk Warehouses Management' module feature.
* Developped by Khoufi Wissem (2018).
* You are not allowed to use it on several site
* You are not allowed to sell or redistribute this module
* This header must not be removed
*
*  @author    KHOUFI Wissem - K.W
*  @copyright Khoufi Wissem
*  @license   http://opensource.org/licenses/afl-3.0.php  Academic Free License (AFL 3.0)
*/
function renderProductVariantsContainer(){$(".ce-product-variants").length>0||0==$(".product-variants").length&&$("#add-to-cart-or-refresh").prepend('<div class="product-variants"></div>')}function fancyCloseBox(e,t){var a='<p style="text-align:right; padding-bottom: 0" class="submit">';a+='<input type="button" onclick="$.fancybox.close();" value="'+txt_ok+'" class="button btn btn-danger">',a+="</p>",$.fancybox('<div class="alert alert-'+t+'">'+e+"</div>"+a)}function displayWarehousesStockInfos(e){var t,a,r;if("undefined"!=typeof display_warehouses_infos&&"none"!=display_warehouses_infos&&"undefined"!=typeof product_stocks_list){if(t=JSON.parse(product_stocks_list),null==e&&(e=getWkEmbeddedProductDetails()),void 0===e&&(e=0),void 0!==e&&($("#block-warehouses-stock").replaceWith(""),void 0!==(a=t[e])&&0!=a.length)){for(r in warehouse_infos='<div id="block-warehouses-stock">',warehouse_infos+='<ul><li><i class="fas fa-warehouse"></i> <b>'+warehouses_txt+"</b></li>",a)a[r].name&&(warehouse_infos+='<li class="item"><i class="fas fa-dot-circle"></i> <strong>'+a[r].name+"</strong>",display_warehouses_stock&&(qty=a[r].available_quantity>0?parseInt(a[r].available_quantity):0,warehouse_infos+='<br ><span><i class="fas fa-caret-right"></i> '+instock_txt+"</span>: ",display_icon?warehouse_infos+='<i class="fas '+(qty>0?"fa-check green":"fa-times red")+'-color"></i> ':warehouse_infos+="<strong>"+qty+"</strong> "+(qty<=1?product_txt:products_txt)),display_warehouses_locations&&a[r].location&&(warehouse_infos+='<br ><span><i class="fas fa-caret-right"></i> '+location_txt+"</span>: ",warehouse_infos+="<strong>"+a[r].location+"</strong>"),display_deliveries_times&&a[r].delivery_time&&(warehouse_infos+='<br ><span><i class="fas fa-calendar"></i> '+a[r].delivery_time+"</span>"),display_warehouses_countries&&a[r].country&&(warehouse_infos+='<br ><span><i class="fas fa-flag"></i> '+a[r].country+"</span>"),warehouse_infos+="</li>");warehouse_infos+="</ul>",warehouse_infos+="</div>",$(".warehousesExtraTabContent").length>0?$(".warehousesExtraTabContent").html(warehouse_infos):($element=$(".product-add-to-cart"),0==$element.length?($(warehouse_infos).insertAfter(".elementor-widget-product-add-to-cart"),$("#block-warehouses-stock").css({"margin-bottom":"20px"})):$element.append(warehouse_infos))}}else $("#block-warehouses-stock").replaceWith("")}function displayProductSelectWarehouse(e){var t,a;"undefined"!=typeof allow_set_warehouse&&allow_set_warehouse||"undefined"!=typeof display_selected_best_warehouse&&display_selected_best_warehouse?(null==e&&(e=getWkEmbeddedProductDetails()),void 0===e&&(e=0),void 0!==e&&(0==e&&renderProductVariantsContainer(),variants_container=".product-variants",$(".ce-product-variants").length>0&&(variants_container=".ce-product-variants"),0==$(".warehouses-select").length&&($(variants_container).append('<div class="warehouses-select clearfix product-variants-item"></div>'),0==$(".ce-product-variants").length&&$(".warehouses-select").css("height",warehouse_select_height>0?warehouse_select_height+"px":"auto"),$(".ce-product-variants").length>0&&$(".warehouses-select").css({padding:"10px 20px 20px 0"})),t={ajax:!0,action:"getWarehouseAsCombination",id_product:$("#product_page_product_id").val(),id_product_attribute:e,quantity_wanted:void 0!==$("#quantity_wanted")&&$("#quantity_wanted").length?parseInt($("#quantity_wanted").val()):1},void 0!==(a=$("#id_warehouse").length>0?$("#id_warehouse").val():$("#add-to-cart-or-refresh input[type=hidden][name='id_warehouse']").val())&&a>0&&(t.id_warehouse=parseInt(a)),$.ajax({url:process_cart_url,type:"POST",async:!1,dataType:"json",data:t,beforeSend:function(){$(".warehouses-select").css("opacity","0.5").html(loading_txt)},success:function(t){var a,r,s;if($(".warehouses-select").css("opacity","1").html(""),void 0!==t.hasError&&t.hasError)$(variants_container).length>0&&$(variants_container).append('<div class="alert alert-warning">'+t.msgError+"</div>");else if(void 0!==t.product_warehouses_select&&t.product_warehouses_select&&(warehouses_stocks_list=t.product_warehouses_select,void 0!==(a=warehouses_stocks_list[e])&&a.length>0)){if(warehouses_select="",allow_set_warehouse){for(warehouses_select+='\t<span class="control-label">'+warehouse_select_label,t.idWarehouseInCart&&t.selected_warehouse==t.idWarehouseInCart&&(warehouses_select+=' <img src="'+module_dir+'views/img/cart-remove-icon.png" title="'+remove_product_cart_txt+'" class="removeWarehouseFromCart" style="cursor:pointer">'),warehouses_select+="</span>",warehouses_select+='\t<select class="form-control form-control-select" id="id_warehouse">',r=0;r<a.length;r++)warehouses_select+='<option value="'+a[r].id_warehouse+'" ',warehouses_select+=t.idWarehouseInCart>0&&t.idWarehouseInCart!=a[r].id_warehouse?" disabled":"",warehouses_select+=t.selected_warehouse==a[r].id_warehouse?" selected":"",warehouses_select+=">",s=getWarehouseInformationsArray(a[r]),warehouses_select+=s.join(" / "),warehouses_select+="</option>";warehouses_select+="\t</select>"}if(display_selected_best_warehouse)for(r=0;r<a.length;r++)if(t.selected_warehouse==a[r].id_warehouse){warehouses_select+='<div class="alert alert-info" role="alert"><strong>'+warehouse_selected_txt+"</strong><br />",s=getWarehouseInformationsArray(a[r]),warehouses_select+=s.join("<br />"),warehouses_select+='<input type="hidden" id="id_warehouse" value="'+t.selected_warehouse+'">',warehouses_select+="</div>";break}$(variants_container+" .warehouses-select").length>0&&($(variants_container+" .warehouses-select").append(warehouses_select),warehouse_select_height=$(".warehouses-select").height()+20,$("#id_warehouse").removeClass("form-control-select"))}}}))):$(".warehouses-select").replaceWith("")}function getWarehouseInformationsArray(e){var t=new Array;return display_warehouse_name&&e.name&&t.push(e.name),display_warehouse_location&&e.location&&t.push(e.location),display_country&&e.country&&t.push(e.country),display_warehouse_quantity&&t.push((e.available_quantity>0?parseInt(e.available_quantity):0)+" "+item_instock_txt),display_delivery_time&&e.delivery_time&&t.push(e.delivery_time),t}var warehouse_select_height,idCombination=0;$(document).ready(function(){null!=window.prestashop&&prestashop.on("updatedProduct",function(e){displayWarehousesStockInfos(e.id_product_attribute),displayProductSelectWarehouse(e.id_product_attribute)}),$("#add-to-cart-or-refresh").prepend('<input type="hidden" name="id_warehouse">'),renderProductVariantsContainer(),displayWarehousesStockInfos(),displayProductSelectWarehouse(),$(document).off("hidden.bs.modal","#blockcart-modal").on("hidden.bs.modal","#blockcart-modal",function(e){$("#quantity_wanted").val(1),prestashop.emit("updateProduct",{reason:e.currentTarget.dataset,event:e})}),$("#add-to-cart-or-refresh button.add-to-cart").on("click",function(e){var t,a,r,s,o;if(e.preventDefault(),e.stopPropagation(),t=$("#product_page_product_id").val(),a=$("#product_customization_id").val(),r=getWkEmbeddedProductDetails(),(s=void 0!==$("#quantity_wanted")&&$("#quantity_wanted").length?parseInt($("#quantity_wanted").val()):1)<1)return fancyCloseBox(txt_invalid_qty,"danger"),!1;o={ajax:!0,action:"initWarehouseProductInCart",id_product:t,quantity_wanted:s,id_product_attribute:r},$("#id_warehouse").length>0&&(o.id_warehouse=parseInt($("#id_warehouse").val())),$.ajax({url:process_cart_url,type:"POST",dataType:"json",data:o,success:function(e){if(void 0!==e.multiWarehousesInCart&&e.multiWarehousesInCart)fancyCloseBox(e.message,"danger");else if(void 0!==e.isMultiCarriersInCart&&e.isMultiCarriersInCart)fancyCloseBox(e.message,"danger");else if(void 0!==e.hasError&&e.hasError)fancyCloseBox(e.message,"danger");else{var o={add:1,action:"update",id_product:t,id_customization:a,qty:s,token:prestashop.static_token};r>0&&(o.id_product_attribute=r),$("#id_warehouse").length>0?o.id_warehouse=parseInt($("#id_warehouse").val()):void 0!==e.id_warehouse&&(o.id_warehouse=parseInt(e.id_warehouse)),$.post(prestashop.urls.pages.cart,o,null,"json").then(function(e){prestashop.emit("updateCart",{reason:{idProduct:e.id_product,idProductAttribute:e.id_product_attribute,idCustomization:e.id_customization,linkAction:"add-to-cart",cart:e.cart},resp:e})}).fail(function(e){prestashop.emit("handleError",{eventType:"addProductToCart",resp:e})})}}})}),$(document).on("change","#id_warehouse",function(e){var t=$(this),a=$("#product_page_product_id").val(),r=getWkEmbeddedProductDetails();return void 0===r&&(r=0),$.ajax({url:process_cart_url,type:"POST",dataType:"json",async:!1,data:{ajax:!0,action:"changeWarehouseFromDropdownListInCart",id_product:a,id_product_attribute:r,id_warehouse:t.val()},success:function(s){if(void 0!==s.hasError)if(s.hasError)t.find("option").prop("selected",function(){return this.defaultSelected}),fancyCloseBox(s.msgError,"danger");else{var o="#add-to-cart-or-refresh";$(o+" input[type=hidden][name='id_warehouse']").val(t.val()),$.post($(o).attr("action"),$(o).serialize()+"&ajax=1&action=productrefresh",null,"json").then(function(t){if(0==r&&renderProductVariantsContainer(),"undefined"!=typeof prestashop)if("undefined"!=typeof ceFrontend&&void 0!==ceFrontend.refreshProduct&&"function"==typeof ceFrontend.refreshProduct){var s=$(o+" > [name=id_product][value="+a+"]")[0];ceFrontend.refreshProduct(s.form)}else prestashop.emit("updateProduct",{eventType:"updatedProductCombination",event:e,reason:{productUrl:t.productUrl},refreshUrl:"",resp:t})})}}}),!1}),$(document).on("click",".removeWarehouseFromCart",function(e){$(this);var t=$("#product_page_product_id").val(),a=getWkEmbeddedProductDetails();return void 0===a&&(a=0),$(".message_product_warehouse").replaceWith(""),$.ajax({url:process_cart_url,type:"POST",dataType:"json",async:!1,data:{ajax:!0,action:"removeWarehouseFromCart",id_product:t,id_product_attribute:a},success:function(a){if(void 0!==a.hasError&&!a.hasError){var r="#add-to-cart-or-refresh";$.post($(r).attr("action"),$(r).serialize()+"&ajax=1&action=productrefresh",null,"json").then(function(a){if("undefined"!=typeof ceFrontend&&void 0!==ceFrontend.refreshProduct&&"function"==typeof ceFrontend.refreshProduct){var s=$(r+" > [name=id_product][value="+t+"]")[0];ceFrontend.refreshProduct(s.form)}else prestashop.emit("updateProduct",{eventType:"updatedProductCombination",event:e,reason:{productUrl:a.productUrl},refreshUrl:"",resp:a})}).fail(function(e){prestashop.emit("handleError",{eventType:"updatedProductCombination",resp:e})})}}}),!1})});
